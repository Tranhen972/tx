<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>B·∫£ng Admin</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #1a1a1a; --container-bg: #2b2b2b; --text-color: #f0f0f0;
            --primary-color: #00aaff; --border-color: #444; --error-color: #e74c3c;
            --success-color: #2ecc71; --warn-color: #f39c12;
            --tai-color: #ff00aa; --xiu-color: #00f0ff;
        }
        body { font-family: Arial, sans-serif; background: var(--bg-color); color: var(--text-color); padding: 15px; text-align: center; }
        .container { max-width: 700px; margin: auto; background: var(--container-bg); border-radius: 12px; padding: 20px; text-align: left; }
        h1 { color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
        .admin-section { background: #3c3c3c; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .admin-section h2 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea {
            width: 100%; padding: 10px; background: var(--bg-color);
            border: 1px solid var(--border-color); color: var(--text-color);
            border-radius: 5px; box-sizing: border-box; font-family: Arial, sans-serif;
        }
        .button-group { display: flex; gap: 10px; }
        .admin-btn { flex: 1; padding: 12px; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; color: white; cursor: pointer; transition: background-color 0.2s; }
        .admin-btn:hover { opacity: 0.8; }
        #btn-add { background-color: var(--success-color); }
        #btn-sub { background-color: var(--error-color); }
        #btn-confirm-deposit { background-color: var(--primary-color); }
        #btn-toggle-ban { background-color: var(--warn-color); }
        #btn-broadcast { background-color: var(--primary-color); }
        #btn-create-code { background-color: var(--success-color); }
        /* N√∫t ch·ªânh c·∫ßu */
        #btn-get-session { background-color: #555; }
        #btn-set-result { background-color: var(--warn-color); } /* N√∫t SET K·∫æT QU·∫¢ */

        #modify-status, #deposit-status, #withdrawal-status, #ban-status, #broadcast-status, #code-status, #history-status, #set-result-status { 
            margin-top: 10px; font-weight: bold; min-height: 20px;
        }
        .list-container { max-height: 300px; overflow-y: auto; background: var(--bg-color); padding: 10px; border-radius: 5px; font-size: 0.9em; }
        .list-container li { list-style: none; padding: 8px 5px; border-bottom: 1px solid var(--border-color); }
        .list-container li:last-child { border-bottom: none; }
        #user-list li { cursor: pointer; transition: background-color 0.2s; }
        #user-list li:hover { background-color: #3c3c3c; }
        .withdrawal-item .info { font-size: 1.1em; }
        .withdrawal-item .bank { font-size: 0.9em; color: #ccc; margin: 5px 0; }
        .withdrawal-item .actions { display: flex; gap: 10px; margin-top: 10px; }
        .wd-btn { padding: 8px 12px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; }
        .btn-approve { background-color: var(--success-color); }
        .btn-deny { background-color: var(--error-color); }
        .error { color: var(--error-color); } .success { color: var(--success-color); }
        .banned-user { color: var(--error-color); text-decoration: line-through; }
        .tab-buttons { display: flex; background-color: #3c3c3c; border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
        .tab-btn { flex: 1; background-color: transparent; color: var(--text-color); border: none; padding: 12px 10px; font-size: 14px; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        .tab-btn:hover { background-color: #555; }
        .tab-btn.active { background-color: var(--primary-color); color: white; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>B·∫£ng Admin</h1>

        <div class="tab-buttons">
            <button class="tab-btn" onclick="openTab(event, 'tab-tools')" id="btn-tab-tools">üõ†Ô∏è C√¥ng c·ª•</button>
            <button class="tab-btn" onclick="openTab(event, 'tab-users')">üë§ Qu·∫£n l√Ω User</button>
            <button class="tab-btn" onclick="openTab(event, 'tab-withdraw')">üí∏ Duy·ªát R√∫t</button>
            <button class="tab-btn" onclick="openTab(event, 'tab-history')">üìä L·ªãch s·ª≠</button>
        </div>

        <div id="tab-tools" class="tab-panel">
            <div class="admin-section">
                <h2>Ch·ªânh K·∫øt Qu·∫£ Phi√™n TX 30s</h2>
                <div class="form-group">
                    <label for="session-id-input">M√£ Phi√™n (B·∫•m "L·∫§Y PHI√äN")</label>
                    <input type="text" id="session-id-input" placeholder="Ch·ªù l·∫•y m√£ phi√™n..." readonly>
                </div>
                <button class="admin-btn" id="btn-get-session" style="margin-bottom: 10px;">L·∫§Y PHI√äN HI·ªÜN T·∫†I</button>

                <div class="form-group">
                    <label for="dice-result-input">Nh·∫≠p 3 s·ªë k·∫øt qu·∫£</label>
                    <input type="number" id="dice-result-input" placeholder="V√≠ d·ª•: 123 (X·ªâu) ho·∫∑c 662 (T√†i)">
                </div>
                <button class="admin-btn" id="btn-set-result">SET K·∫æT QU·∫¢ (VD: 241)</button>
                <div id="set-result-status"></div>
            </div>

            <div class="admin-section">
                <h2>G·ª≠i Th√¥ng B√°o (Broadcast)</h2>
                <div class="form-group"><label for="broadcast-message">N·ªôi dung (H·ªó tr·ª£ HTML)</label><textarea id="broadcast-message" rows="3" placeholder="V√≠ d·ª•: <b>B·∫£o tr√¨ 5 ph√∫t!</b>"></textarea></div>
                <button class="admin-btn" id="btn-broadcast">G·ª¨I TH√îNG B√ÅO</button>
                <div id="broadcast-status"></div>
            </div>
            <div class="admin-section">
                <h2>T·∫°o Giftcode</h2>
                <div class="button-group">
                    <div class="form-group" style="flex: 2;"><label for="code-name">M√£ Code (IN HOA)</label><input type="text" id="code-name" placeholder="TESTCODE"></div>
                    <div class="form-group" style="flex: 1;"><label for="code-amount">S·ªë ti·ªÅn</label><input type="number" id="code-amount" placeholder="10000"></div>
                    <div class="form-group" style="flex: 1;"><label for="code-limit">S·ªë l∆∞·ª£t d√πng</label><input type="number" id="code-limit" placeholder="100" value="1"></div>
                </div>
                <button class="admin-btn" id="btn-create-code">T·∫†O CODE</button>
                <div id="code-status"></div>
            </div>
            <div class="admin-section">
                <h2>X√°c nh·∫≠n N·∫°p ti·ªÅn</h2>
                <div class="form-group"><label for="deposit-user-id">ID Ng∆∞·ªùi d√πng (N·ªôi dung CK)</label><input type="text" id="deposit-user-id" placeholder="Nh·∫≠p ID user ƒë√£ n·∫°p ti·ªÅn"></div>
                <div class="form-group"><label for="deposit-amount">S·ªë ti·ªÅn n·∫°p</label><input type="number" id="deposit-amount" placeholder="Nh·∫≠p s·ªë ti·ªÅn user ƒë√£ chuy·ªÉn"></div>
                <button class="admin-btn" id="btn-confirm-deposit">X√ÅC NH·∫¨N N·∫†P</button>
                <div id="deposit-status"></div>
            </div>
        </div>

        <div id="tab-users" class="tab-panel">
            <div class="admin-section">
                <h2>Qu·∫£n l√Ω S·ªë d∆∞ (C·ªông/Tr·ª´)</h2>
                <div class="form-group"><label for="target-user-id">ID Ng∆∞·ªùi d√πng</label><input type="text" id="target-user-id" placeholder="Click v√†o user b√™n d∆∞·ªõi ƒë·ªÉ ch·ªçn"></div>
                <div class="form-group"><label for="modify-amount">S·ªë ti·ªÅn</label><input type="number" id="modify-amount" placeholder="V√≠ d·ª•: 50000 (c·ªông) ho·∫∑c -20000 (tr·ª´)"></div>
                <div class="button-group">
                    <button class="admin-btn" id="btn-add">C·ªòNG TI·ªÄN</button>
                    <button class="admin-btn" id="btn-sub">TR·ª™ TI·ªÄN</button>
                </div>
                <div id="modify-status"></div>
            </div>
            <div class="admin-section">
                <h2>Qu·∫£n l√Ω User (Ban/Unban)</h2>
                <div class="form-group"><label for="ban-user-id">ID Ng∆∞·ªùi d√πng</label><input type="text" id="ban-user-id" placeholder="Click v√†o user b√™n d∆∞·ªõi ƒë·ªÉ ch·ªçn"></div>
                <button class="admin-btn" id="btn-toggle-ban">BAN / UNBAN USER</button>
                <div id="ban-status"></div>
            </div>
            <div class="admin-section" id="user-list-container">
                <h2>Danh s√°ch User (<span id="user-count">0</span>)</h2>
                <div class="list-container" id="user-list">ƒêang t·∫£i...</div>
            </div>
        </div>

        <div id="tab-withdraw" class="tab-panel">
            <div class="admin-section" id="withdrawal-list-container">
                <h2>Y√™u c·∫ßu R√∫t ti·ªÅn ƒëang ch·ªù (<span id="withdrawal-count">0</span>)</h2>
                <div class="list-container" id="withdrawal-list">ƒêang t·∫£i...</div>
                <div id="withdrawal-status"></div>
            </div>
        </div>

        <div id="tab-history" class="tab-panel">
            <div class="admin-section" id="history-list-container">
                <h2>L·ªãch s·ª≠ C∆∞·ª£c To√†n C·∫ßu (50)</h2>
                <button class="admin-btn" id="btn-load-history" style="background-color: #555;">T·∫¢I L·ªäCH S·ª¨ C∆Ø·ª¢C</button>
                <div class="list-container" id="history-list" style="margin-top: 10px;">...</div>
                <div id="history-status"></div>
            </div>
        </div>
    </div>

    <script>
        // === URL API (ƒê√É S·ª¨A) ===
        const API_URL = "https://b8925e2e-6861-4573-ae45-26e3c60987b8-00-3ghb3td81ffx1.sisko.replit.dev";
        // =======================

        const tg = window.Telegram.WebApp;
        let ADMIN_ID = null; 

        // (L·∫•y c√°c element DOM)
        const userListEl = document.getElementById('user-list');
        const userCountEl = document.getElementById('user-count');
        const targetUserIdEl = document.getElementById('target-user-id');
        const modifyAmountEl = document.getElementById('modify-amount');
        const modifyStatusEl = document.getElementById('modify-status');
        const withdrawalListEl = document.getElementById('withdrawal-list');
        const withdrawalCountEl = document.getElementById('withdrawal-count');
        const withdrawalStatusEl = document.getElementById('withdrawal-status');
        const depositUserIdEl = document.getElementById('deposit-user-id');
        const depositAmountEl = document.getElementById('deposit-amount');
        const depositStatusEl = document.getElementById('deposit-status');
        const banUserIdEl = document.getElementById('ban-user-id');
        const banStatusEl = document.getElementById('ban-status');
        const broadcastMsgEl = document.getElementById('broadcast-message');
        const broadcastStatusEl = document.getElementById('broadcast-status');
        const codeNameEl = document.getElementById('code-name');
        const codeAmountEl = document.getElementById('code-amount');
        const codeLimitEl = document.getElementById('code-limit'); 
        const codeStatusEl = document.getElementById('code-status');
        const historyListEl = document.getElementById('history-list');
        const historyStatusEl = document.getElementById('history-status');

        // === ELEMENT M·ªöI ƒê·ªÇ CH·ªàNH C·∫¶U ===
        const sessionIdInput = document.getElementById('session-id-input');
        const diceResultInput = document.getElementById('dice-result-input'); // √î nh·∫≠p 3 s·ªë
        const setResultStatusEl = document.getElementById('set-result-status');
        // ==============================

        function openTab(evt, tabName) {
            let tabPanels = document.getElementsByClassName("tab-panel");
            for (let i = 0; i < tabPanels.length; i++) tabPanels[i].style.display = "none";
            let tabButtons = document.getElementsByClassName("tab-btn");
            for (let i = 0; i < tabButtons.length; i++) tabButtons[i].className = tabButtons[i].className.replace(" active", "");
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        window.onload = function() {
            tg.ready(); tg.expand(); 
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                ADMIN_ID = tg.initDataUnsafe.user.id;
                loadAllUsers(); 
                loadWithdrawals();

                // G√°n s·ª± ki·ªán
                document.getElementById('btn-add').onclick = () => modifyBalance(true);
                document.getElementById('btn-sub').onclick = () => modifyBalance(false);
                document.getElementById('btn-confirm-deposit').onclick = confirmDeposit;
                document.getElementById('btn-toggle-ban').onclick = toggleBan;
                document.getElementById('btn-broadcast').onclick = broadcastMessage;
                document.getElementById('btn-create-code').onclick = createGiftcode;
                document.getElementById('btn-load-history').onclick = loadAllBetHistory;

                // === G√ÅN S·ª∞ KI·ªÜN M·ªöI ===
                document.getElementById('btn-get-session').onclick = getSessionId;
                document.getElementById('btn-set-result').onclick = setResult; // S·ª≠a
                // ======================

                document.getElementById('btn-tab-tools').click(); // M·ªü tab ƒë·∫ßu ti√™n
            } else {
                document.body.innerHTML = `<h1 style="color: red;">L·ªñI X√ÅC TH·ª∞C</h1>`;
            }
        };

        // --- H√†m API Helper ---
        async function callApi(endpoint, method = 'GET', body = null) {
            const url = `${API_URL}${endpoint}`;
            const options = {
                method: method,
                headers: {'Content-Type': 'application/json'}
            };
            if (body) {
                options.body = JSON.stringify(body);
            }
            try {
                const response = await fetch(url, options);
                const data = await response.json();
                return { ok: response.ok, data: data };
            } catch (error) {
                console.error(`API Error (${endpoint}):`, error);
                return { ok: false, data: { error: "L·ªói k·∫øt n·ªëi API." } };
            }
        }

        // (T·∫•t c·∫£ c√°c h√†m JavaScript kh√°c gi·ªØ nguy√™n y h·ªát)
        async function loadAllUsers() {
            const { ok, data } = await callApi(`/admin/all_users?admin_id=${ADMIN_ID}`);
            if (ok) {
                let userListHtml = '<ul>'; let userCount = 0;
                for (const id in data) {
                    const user = data[id];
                    const banClass = user.is_banned ? 'banned-user' : '';
                    userListHtml += `<li onclick="selectUser('${id}', '${user.username}')" class="${banClass}">
                        <strong>${user.username}</strong> (ID: ${id}) ${user.is_banned ? '<b>[BANNED]</b>' : ''}<br>
                        S·ªë d∆∞: ${user.balance.toLocaleString('vi-VN')} ƒë
                    </li>`;
                    userCount++;
                }
                userListHtml += '</ul>'; userCountEl.innerText = userCount; userListEl.innerHTML = userListHtml;
            } else { userListEl.innerHTML = `<div class="error">L·ªói: ${data.error}</div>`; }
        }
        function selectUser(id, username) {
            targetUserIdEl.value = id; 
            depositUserIdEl.value = id;
            banUserIdEl.value = id; 
            modifyAmountEl.placeholder = `S·ª≠a ti·ªÅn cho ${username}`;
            document.querySelector("button[onclick*='tab-users']").click();
            window.scrollTo(0, 0);
        }
        async function modifyBalance(isAdding) {
            const targetId = targetUserIdEl.value; let amountStr = modifyAmountEl.value;
            if (!targetId || !amountStr) { modifyStatusEl.className = 'error'; modifyStatusEl.innerText = "Vui l√≤ng nh·∫≠p ID User v√† S·ªë ti·ªÅn."; return; }
            let amount = parseInt(amountStr);
            if (isNaN(amount) || amount === 0) { modifyStatusEl.className = 'error'; modifyStatusEl.innerText = "S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá."; return; }
            if (!isAdding) { amount = -Math.abs(amount); } else { amount = Math.abs(amount); }
            modifyStatusEl.className = 'info'; modifyStatusEl.innerText = "ƒêang x·ª≠ l√Ω...";
            const { ok, data } = await callApi('/admin/modify_balance', 'POST', { admin_id: ADMIN_ID, target_user_id: targetId, amount: amount });
            if (ok) {
                modifyStatusEl.className = 'success'; modifyStatusEl.innerText = data.message;
                loadAllUsers(); modifyAmountEl.value = "";
            } else { modifyStatusEl.className = 'error'; modifyStatusEl.innerText = `L·ªói: ${data.error}`; }
        }
        async function loadWithdrawals() {
            withdrawalStatusEl.innerText = "";
            const { ok, data } = await callApi(`/admin/pending_withdrawals?admin_id=${ADMIN_ID}`);
            if (ok) {
                let listHtml = '<ul>'; let count = 0;
                if (data.length === 0) { listHtml = "Kh√¥ng c√≥ y√™u c·∫ßu n√†o ƒëang ch·ªù."; }
                else {
                    for (const req of data) {
                        listHtml += `<li class="withdrawal-item" id="wd-${req.id}">
                            <div class="info"><strong>${req.username}</strong> (ID: ${req.user_id})<br>R√∫t: <strong style="color: var(--warn-color);">${req.amount.toLocaleString('vi-VN')} ƒë</strong></div>
                            <div class="bank">BANK: ${req.bank_info}</div>
                            <div class="actions">
                                <button class="wd-btn btn-approve" onclick="processWithdrawal('${req.id}', 'approve')">DUY·ªÜT</button>
                                <button class="wd-btn btn-deny" onclick="processWithdrawal('${req.id}', 'deny')">T·ª™ CH·ªêI</button>
                            </div></li>`;
                        count++;
                    } listHtml += '</ul>';
                }
                withdrawalCountEl.innerText = count; withdrawalListEl.innerHTML = listHtml;
            } else { withdrawalListEl.innerHTML = `<div class="error">L·ªói: ${data.error}</div>`; }
        }
        async function processWithdrawal(withdrawal_id, action) {
            let note = ""; let requestBody = { admin_id: ADMIN_ID, withdrawal_id: withdrawal_id, action: action };
            if (action === 'approve') { if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën DUY·ªÜT y√™u c·∫ßu ${withdrawal_id} kh√¥ng?`)) return; } 
            else if (action === 'deny') {
                note = prompt(`Vui l√≤ng nh·∫≠p L√ù DO T·ª™ CH·ªêI cho y√™u c·∫ßu ${withdrawal_id}:`);
                if (!note) { alert("B·∫°n ph·∫£i nh·∫≠p l√Ω do ƒë·ªÉ t·ª´ ch·ªëi."); return; }
                requestBody.note = note;
            }
            withdrawalStatusEl.className = 'info'; withdrawalStatusEl.innerText = "ƒêang x·ª≠ l√Ω...";
            const { ok, data } = await callApi('/admin/process_withdrawal', 'POST', requestBody);
            if (ok) {
                withdrawalStatusEl.className = 'success'; withdrawalStatusEl.innerText = data.message;
                loadWithdrawals(); loadAllUsers(); 
            } else { withdrawalStatusEl.className = 'error'; withdrawalStatusEl.innerText = `L·ªói: ${data.error}`; }
        }
        async function confirmDeposit() {
            const targetId = depositUserIdEl.value; const amountStr = depositAmountEl.value;
            if (!targetId || !amountStr) { depositStatusEl.className = 'error'; depositStatusEl.innerText = "Vui l√≤ng nh·∫≠p ID User v√† S·ªë ti·ªÅn n·∫°p."; return; }
            let amount = parseInt(amountStr);
            if (isNaN(amount) || amount <= 0) { depositStatusEl.className = 'error'; depositStatusEl.innerText = "S·ªë ti·ªÅn n·∫°p kh√¥ng h·ª£p l·ªá."; return; }
            depositStatusEl.className = 'info'; depositStatusEl.innerText = "ƒêang x·ª≠ l√Ω...";
            const { ok, data } = await callApi('/admin/confirm_deposit', 'POST', { admin_id: ADMIN_ID, target_user_id: targetId, amount: amount });
            if (ok) {
                depositStatusEl.className = 'success'; depositStatusEl.innerText = data.message;
                loadAllUsers(); depositUserIdEl.value = ""; depositAmountEl.value = "";
            } else { depositStatusEl.className = 'error'; depositStatusEl.innerText = `L·ªói: ${data.error}`; }
        }
        async function toggleBan() {
            const targetId = banUserIdEl.value;
            if (!targetId) { banStatusEl.className = 'error'; banStatusEl.innerText = "Vui l√≤ng ch·ªçn user."; return; }
            banStatusEl.className = 'info'; banStatusEl.innerText = "ƒêang x·ª≠ l√Ω...";
            const { ok, data } = await callApi('/admin/toggle_ban', 'POST', { admin_id: ADMIN_ID, target_user_id: targetId });
            if (ok) {
                banStatusEl.className = 'success'; banStatusEl.innerText = data.message;
                loadAllUsers(); 
            } else { banStatusEl.className = 'error'; banStatusEl.innerText = `L·ªói: ${data.error}`; }
        }
        async function broadcastMessage() {
            const message = broadcastMsgEl.value;
            if (!message) { broadcastStatusEl.className = 'error'; broadcastStatusEl.innerText = "Vui l√≤ng nh·∫≠p n·ªôi dung."; return; }
            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën g·ª≠i th√¥ng b√°o n√†y ƒë·∫øn T·∫§T C·∫¢ user?")) return;
            broadcastStatusEl.className = 'info'; broadcastStatusEl.innerText = "ƒêang g·ª≠i...";
            const { ok, data } = await callApi('/admin/broadcast', 'POST', { admin_id: ADMIN_ID, message: message });
            if (ok) {
                broadcastStatusEl.className = 'success'; broadcastStatusEl.innerText = data.message;
                broadcastMsgEl.value = "";
            } else { broadcastStatusEl.className = 'error'; broadcastStatusEl.innerText = `L·ªói: ${data.error}`; }
        }
        async function createGiftcode() {
            const code = codeNameEl.value.toUpperCase();
            const amountStr = codeAmountEl.value;
            const limitStr = codeLimitEl.value; 
            if (!code || !amountStr || !limitStr) {
                codeStatusEl.className = 'error'; 
                codeStatusEl.innerText = "Vui l√≤ng nh·∫≠p M√£ code, S·ªë ti·ªÅn, v√† S·ªë l∆∞·ª£t d√πng."; 
                return; 
            }
            let amount = parseInt(amountStr);
            let limit = parseInt(limitStr); 
            if (isNaN(amount) || amount <= 0 || isNaN(limit) || limit <= 0) {
                codeStatusEl.className = 'error'; 
                codeStatusEl.innerText = "S·ªë ti·ªÅn v√† S·ªë l∆∞·ª£t d√πng ph·∫£i l√† s·ªë l·ªõn h∆°n 0."; 
                return; 
            }
            codeStatusEl.className = 'info'; codeStatusEl.innerText = "ƒêang t·∫°o...";
            const { ok, data } = await callApi('/admin/create_giftcode', 'POST', { 
                admin_id: ADMIN_ID, code: code, amount: amount, limit: limit 
            });
            if (ok) {
                codeStatusEl.className = 'success'; codeStatusEl.innerText = data.message;
                codeNameEl.value = ""; codeAmountEl.value = ""; codeLimitEl.value = "1";
            } else { codeStatusEl.className = 'error'; codeStatusEl.innerText = `L·ªói: ${data.error}`; }
        }
        async function loadAllBetHistory() {
            historyStatusEl.innerText = "";
            historyListEl.innerHTML = "ƒêang t·∫£i...";
            const { ok, data } = await callApi(`/admin/all_bet_history?admin_id=${ADMIN_ID}`);
            if (ok) {
                let listHtml = '<ul>';
                if (data.length === 0) { listHtml = "Ch∆∞a c√≥ ai c∆∞·ª£c."; }
                else {
                    for (const log of data) {
                        const icon = log.change > 0 ? 'üü¢' : 'üî¥';
                        listHtml += `<li>
                            ${icon} <strong>${log.username || log.user_id}</strong>
                            (${log.choice} -> ${log.result})
                            | ƒê·ªïi: <strong>${log.change.toLocaleString('vi-VN')}ƒë</strong>
                            <br><small style="color: #888;">${log.time}</small>
                        </li>`;
                    }
                    listHtml += '</ul>';
                }
                historyListEl.innerHTML = listHtml;
            } else { historyListEl.innerHTML = `<div class="error">L·ªói: ${data.error}</div>`; }
        }

        // === H√ÄM M·ªöI: CH·ªàNH K·∫æT QU·∫¢ ===
        let currentSessionId = 0;
        async function getSessionId() {
            setResultStatusEl.className = 'info';
            setResultStatusEl.innerText = "ƒêang l·∫•y phi√™n...";

            // G·ªçi API /game/tx30/status ƒë·ªÉ l·∫•y phi√™n
            const { ok, data } = await callApi('/game/tx30/status'); 

            if (ok) {
                if(data.status === 'pending') {
                    currentSessionId = data.session_id;
                    sessionIdInput.value = currentSessionId;
                    setResultStatusEl.className = 'success';
                    setResultStatusEl.innerText = `ƒê√£ l·∫•y phi√™n #${currentSessionId}. (C√≤n ${data.time_left}s)`;
                } else {
                    currentSessionId = 0;
                    sessionIdInput.value = "";
                    setResultStatusEl.className = 'error';
                    setResultStatusEl.innerText = "ƒê√£ h·∫øt th·ªùi gian c∆∞·ª£c. Ch·ªù phi√™n m·ªõi.";
                }
            } else {
                setResultStatusEl.className = 'error';
                setResultStatusEl.innerText = `L·ªói: ${data.error}`;
            }
        }

        async function setResult() {
            const diceString = diceResultInput.value; // L·∫•y 3 s·ªë

            if (currentSessionId === 0) {
                setResultStatusEl.className = 'error';
                setResultStatusEl.innerText = "Vui l√≤ng 'L·∫§Y PHI√äN' tr∆∞·ªõc.";
                return;
            }
            if (!diceString || diceString.length !== 3 || !/^[1-6]{3}$/.test(diceString)) {
                setResultStatusEl.className = 'error';
                setResultStatusEl.innerText = "L·ªói: K·∫øt qu·∫£ ph·∫£i l√† 3 s·ªë (v√≠ d·ª•: 123, 666).";
                return;
            }

            setResultStatusEl.className = 'info';
            setResultStatusEl.innerText = `ƒêang ch·ªânh k·∫øt qu·∫£ th√†nh ${diceString}...`;

            const { ok, data } = await callApi('/admin/set_result', 'POST', {
                admin_id: ADMIN_ID,
                session_id: currentSessionId,
                dice: diceString // G·ª≠i 3 s·ªë
            });

            if (ok) {
                setResultStatusEl.className = 'success';
                setResultStatusEl.innerText = data.message;
            } else {
                setResultStatusEl.className = 'error';
                setResultStatusEl.innerText = `L·ªói: ${data.error}`;
            }
            currentSessionId = 0;
            sessionIdInput.value = "";
            diceResultInput.value = "";
        }

    </script>
</body>
</html>
